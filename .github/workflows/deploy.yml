name: CI/CD Lambda (dev)

on:
  push:
    branches:
      - main  # Cambia si usas otra rama para desarrollo

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: dev  # üëà Activa las variables y secretos del entorno "dev"

    env:
      AWS_REGION: ${{ vars.AWS_REGION_DEV }}
      FUNCTION_NAME: ${{ vars.FUNCTION_NAME_DEV }}
      LAMBDA_RUNTIME: ${{ vars.LAMBDA_RUNTIME_DEV }}
      LAMBDA_HANDLER: ${{ vars.LAMBDA_HANDLER_DEV }}
      LAMBDA_ROLE_ARN: ${{ vars.LAMBDA_ROLE_ARN_DEV }}
      LAMBDA_TIMEOUT: ${{ vars.LAMBDA_TIMEOUT_DEV }} 

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3

    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Instalar dependencias
      run: npm install

    - name: Configurar credenciales AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Empaquetar c√≥digo
      run: |
        if [ ! -f index.js ]; then
          echo "ERROR: No se encontr√≥ index.js"
          exit 1
        fi
        zip -r function.zip index.js

    - name: Crear o actualizar funci√≥n Lambda
      run: |
        echo "Verificando si existe la funci√≥n: $FUNCTION_NAME"
        if aws lambda get-function --function-name "$FUNCTION_NAME" --region "$AWS_REGION" > /dev/null 2>&1; then
          echo "‚úÖ La funci√≥n existe, actualizando c√≥digo..."
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --zip-file fileb://function.zip \
            --timeout "$LAMBDA_TIMEOUT" \ 
            --region "$AWS_REGION"
        else
          echo "‚ö†Ô∏è La funci√≥n no existe, creando..."
          aws lambda create-function \
            --function-name "$FUNCTION_NAME" \
            --runtime "$LAMBDA_RUNTIME" \
            --role "$LAMBDA_ROLE_ARN" \
            --handler "$LAMBDA_HANDLER" \
            --zip-file fileb://function.zip \
            --timeout "$LAMBDA_TIMEOUT" \
            --region "$AWS_REGION"
        fi